angular.module("ecModal",[]).directive("overlay",["$ecModalStack",function(a){return{restrict:"A",replace:!0,template:'<div class="md-overlay" ng-style="{\'z-index\': 1040 + (index && 1 || 0) + index*10}"></div>',link:function(b,c,d){b.close=function(c){var d=a.getTop();d&&c.target===c.currentTarget&&(c.preventDefault(),c.stopPropagation(),d.value.overlayClose&&b.$apply(function(){a.close(d.key)}))},c.on("click",b.close)}}}]).factory("$$stackedMap",function(){return{createNew:function(){var a=[];return{add:function(b,c){a.push({key:b,value:c})},get:function(b){for(var c=0;c<a.length;c++)if(b==a[c].key)return a[c]},keys:function(){for(var b=[],c=0;c<a.length;c++)b.push(a[c].key);return b},top:function(){return a[a.length-1]},remove:function(b){for(var c=-1,d=0;d<a.length;d++)if(b==a[d].key){c=d;break}return a.splice(c,1)[0]},removeTop:function(){return a.splice(a.length-1,1)[0]},length:function(){return a.length}}}}}).factory("$ecModalStack",["$document","$compile","$rootScope","$q","$injector","$$stackedMap",function(a,b,c,d,e,f){function j(a,b){var c=g.get(a).value;g.remove(a),c.modalDomEl.remove();var d=k();0==d&&(h.remove(),h=void 0,i.$destroy(),i=void 0),c.modalScope.$destroy(),b&&b.focus&&b.focus()}function k(){var a=g.keys();return a.length}var h,i,g=f.createNew();c.$watch(k,function(a){i&&(i.index=a)});var l={getTop:function(){return g.top()},open:function(d,e){var f=a[0].activeElement;g.add(d,{deferred:e.deferred,overlayClose:e.overlayClose,modalScope:e.scope});var j=a.find("body").eq(0),l=k();if(l>0&&!h){i=c.$new(!0),i.index=l;var m=angular.element("<div overlay></div>");h=b(m)(i),j.append(m)}var n=angular.element(e.content);n.css({"z-index":1050+10*k()});var o=b(n)(e.scope);g.top().value.modalDomEl=o,g.top().value.modalOpener=f,j.append(o)},close:function(a,b){var c=g.get(a);return c?(c.value.modalScope.$$uibDestructionScheduled=!0,c.value.deferred.resolve(b),j(a,c.value.modalOpener),!0):!c}};return l}]).provider("$ecModal",function(){var a={options:{template:null,templateUrl:null,controller:"",controllerAs:"",overlayClose:!1,resolve:{}},$get:["$injector","$rootScope","$templateRequest","$controller","$q","$ecModalStack",function(b,c,d,e,f,g){return{open:function(h){function l(a){return a.template?f.when(a.template):d(angular.isFunction(a.templateUrl)?a.templateUrl():a.templateUrl)}function m(a){var c=[];return angular.forEach(a,function(a){angular.isFunction(a)||angular.isArray(a)?c.push(f.when(b.invoke(a))):angular.isString(a)?c.push(f.when(b.get(a))):c.push(f.when(a))}),c}var i=f.defer(),j=f.defer(),k={result:i.promise,opened:j.promise,close:function(a){var b=f.defer();return g.close(k,a)?b.resolve(!0):b.reject("close failed."),b.promise}};if(h=angular.extend({},a.options,h),h.resolve=h.resolve||{},!h.template&&!h.templateUrl)throw new Error("One of template or templateUrl options is required.");var n=f.all([l(h)].concat(m(h.resolve)));return n.then(function(a){var b=(h.scope||c).$new();b.$close=k.close,b.$on("$destroy",function(){b.$$uibDestructionScheduled||b.$close()});var d,f={},l=1;h.controller&&(f.$scope=b,f.$ecModalInstance=k,angular.forEach(h.resolve,function(b,c){f[c]=a[l++]}),d=e(h.controller,f),h.controllerAs&&(h.bindToController&&angular.extend(d,b),b[h.controllerAs]=d)),g.open(k,{scope:b,deferred:i,content:a[0],overlayClose:h.overlayClose}),j.resolve(!0)},function(a){j.reject(a),i.reject(a)}),k}}}]};return a});